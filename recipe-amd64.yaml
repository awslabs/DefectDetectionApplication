---
RecipeFormatVersion: "2020-01-25"
ComponentName: "aws.edgeml.dda.LocalServer.amd64"
ComponentVersion: "1.0.0"
ComponentDescription: DDA Local Web Server App - AMD64
ComponentPublisher: Amazon
ComponentDependencies:
  aws.greengrass.Nucleus:
    VersionRequirement: ">=2.4.0"
  aws.greengrass.ShadowManager:
    VersionRequirement: ">=2.2.0"
ComponentConfiguration:
  DefaultConfiguration:
    StreamShadowName: "streamConfigurationShadow"
    AppRunnerShadowName: "appRunnerShadow"
    accessControl:
      aws.greengrass.ShadowManager:
        'aws.edgeml.dda.LocalServer.amd64:shadow:1':
          policyDescription: 'Allows access to shadows'
          operations:
            - 'aws.greengrass#GetThingShadow'
            - 'aws.greengrass#UpdateThingShadow'
          resources:
            - $aws/things/*/shadow
            - $aws/things/*/shadow/name/*
        'aws.edgeml.dda.LocalServer.amd64:shadow:2':
          policyDescription: 'Allows access to things with shadows'
          operations:
            - 'aws.greengrass#ListNamedShadowsForThing'
          resources:
            - '*'
      aws.greengrass.ipc.mqttproxy:
        'aws.edgeml.dda.LocalServer.amd64:mqttproxy:1':
          policyDescription: Allows access to shadow pubsub topics
          operations:
            - "aws.greengrass#SubscribeToIoTCore"
            - "aws.greengrass#PublishToIoTCore"
          resources:
            - $aws/things/*/shadow/name/*
      aws.greengrass.Cli:
        'aws.edgeml.dda.LocalServer.amd64:cli:1':
          policyDescription: 'Allows access to restart and stop DDA greengrass components'
          operations:
            - 'aws.greengrass#RestartComponent'
            - 'aws.greengrass#StopComponent'
          resources:
            - 'aws.edgeml.dda.*'
            - 'model*'
        'aws.edgeml.dda.LocalServer.amd64:cli:2':
          policyDescription: 'Allows access to list and get details for greengrass components on device'
          operations:
            - 'aws.greengrass#ListComponents'
            - 'aws.greengrass#GetComponentDetails'
          resources:
            - '*'
Manifests:
  - Platform:
      os: linux
      architecture: x86_64
    Lifecycle:
      Install:
        RequiresPrivilege: true
        Script: |
          docker images --quiet --filter=dangling=true | xargs --no-run-if-empty docker rmi -f && docker load -i {artifacts:decompressedPath}/aws.edgeml.dda.LocalServer.amd64-x86_64/custom-build/aws.edgeml.dda.LocalServer.amd64/flask-app.tar && docker load -i {artifacts:decompressedPath}/aws.edgeml.dda.LocalServer.amd64-x86_64/custom-build/aws.edgeml.dda.LocalServer.amd64/react-webapp.tar
      Run:
        RequiresPrivilege: true
        SetEnv:
          COMPONENT_WORK_PATH: "{work:path}"
          KERNEL_ROOT_PATH: "{kernel:rootPath}"
          INFERENCE_COMPONENT_DECOMPRESED_PATH: "{aws.edgeml.dda.InferenceApp:artifacts:decompressedPath}"
          LOCAL_SERVER_COMPONENT_DECOMPRESSED_PATH: "{artifacts:decompressedPath}/aws.edgeml.dda.LocalServer.amd64-x86_64"
        Script: |
          bash {artifacts:decompressedPath}/aws.edgeml.dda.LocalServer.amd64-x86_64/custom-build/aws.edgeml.dda.LocalServer.amd64/host_scripts/setup_dda_users.sh ;
          bash {artifacts:decompressedPath}/aws.edgeml.dda.LocalServer.amd64-x86_64/custom-build/aws.edgeml.dda.LocalServer.amd64/host_scripts/get_nvidia_libs_versions.sh;
          bash {artifacts:decompressedPath}/aws.edgeml.dda.LocalServer.amd64-x86_64/custom-build/aws.edgeml.dda.LocalServer.amd64/host_scripts/setup_paths.sh;
          export $(grep -v '^#' /tmp/.dda.env | xargs) ;
          docker compose --profile $DOCKER_PROFILE -f {artifacts:decompressedPath}/aws.edgeml.dda.LocalServer.amd64-x86_64/custom-build/aws.edgeml.dda.LocalServer.amd64/docker-compose.yaml up --no-build ;
      Shutdown:
        RequiresPrivilege: true
        Script: |
          docker compose --profile $DOCKER_PROFILE -f {artifacts:decompressedPath}/aws.edgeml.dda.LocalServer.amd64-x86_64/custom-build/aws.edgeml.dda.LocalServer.amd64/docker-compose.yaml down
    Artifacts:
      - URI: s3://BUCKET_NAME/COMPONENT_NAME/COMPONENT_VERSION/aws.edgeml.dda.LocalServer.amd64-x86_64.zip
        Unarchive: ZIP